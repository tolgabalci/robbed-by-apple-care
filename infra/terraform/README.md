# RobbedByAppleCare Infrastructure

This directory contains the Terraform infrastructure as code for the RobbedByAppleCare project.

## Architecture Overview

The infrastructure consists of:
- Azure Front Door with WAF for global load balancing and security
- Azure Static Web Apps for hosting the Next.js application
- Azure Virtual Machine running Discourse in Docker
- Azure Database for PostgreSQL for Discourse data
- Azure Blob Storage for file uploads
- Azure Key Vault for secret management
- Azure DNS for domain management

## Prerequisites

1. Azure CLI installed and authenticated
2. Terraform >= 1.6.0 installed
3. Required Azure permissions for resource creation
4. Backend storage account for Terraform state

## Backend Configuration

The Terraform state is stored in Azure Storage. Configure the following secrets in GitHub:

- `TF_STATE_RESOURCE_GROUP`: Resource group containing the storage account
- `TF_STATE_STORAGE_ACCOUNT`: Storage account name for Terraform state
- `TF_STATE_CONTAINER`: Container name for state files

## Deployment

### Via GitHub Actions (Recommended)

1. **Pull Request**: Creates a Terraform plan and posts it as a comment
2. **Release Tag**: Applies the Terraform configuration to production

### Manual Deployment

```bash
# Initialize Terraform
terraform init \
  -backend-config="resource_group_name=<state-rg>" \
  -backend-config="storage_account_name=<state-storage>" \
  -backend-config="container_name=<state-container>" \
  -backend-config="key=terraform.tfstate"

# Plan changes
terraform plan -out=tfplan

# Apply changes
terraform apply tfplan
```

## Security

- All resources use managed identities where possible
- Secrets are stored in Azure Key Vault
- Network security groups restrict access
- Encryption at rest is enabled for all data stores
- WAF protects against common web attacks

## Monitoring

- Security scanning via Checkov, TFSec, and Trivy
- Cost estimation via Infracost
- Drift detection on main branch pushes
- Compliance checking against Azure Security Baseline

## Modules

<!-- BEGIN_TF_DOCS -->
<!-- This section will be auto-generated by terraform-docs -->
<!-- END_TF_DOCS -->

## Troubleshooting

### Common Issues

1. **State Lock**: If Terraform state is locked, check for running deployments
2. **Permission Errors**: Ensure service principal has required permissions
3. **Resource Conflicts**: Check for existing resources with same names

### Support

For infrastructure issues, check:
1. GitHub Actions logs for deployment failures
2. Azure Portal for resource status
3. Terraform state for configuration drift